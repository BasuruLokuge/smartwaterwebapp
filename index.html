<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP8266 IoT Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
    </style>
</head>
<body class="p-4 md:p-8 bg-gray-50 min-h-screen flex items-start justify-center">

    <div class="w-full max-w-lg bg-white shadow-xl rounded-xl p-6 md:p-8 border border-blue-100">
        <h1 class="text-3xl font-bold text-center text-blue-700 mb-6">IoT Water Quality & Control</h1>
        <p class="text-sm text-gray-500 text-center mb-8">
            This Web App shows the Real Time PPM  send from ESP8266.
        </p>

        <!-- Real-Time TDS Display -->
        <div class="bg-indigo-50 border-l-4 border-indigo-500 rounded-lg p-5 mb-4 flex items-center justify-between">
            <div>
                <p class="text-sm text-indigo-700 font-medium">Real-Time TDS Reading</p>
                <p class="text-4xl font-extrabold text-indigo-900 mt-1">
                    <span id="tdsValue">---</span> ppm
                </p>
            </div>
            <button onclick="fetchTdsData()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-full transition duration-300 shadow-md">
                <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2.1m15.357 2.1H15"></path></svg>
                Refresh
            </button>
        </div>

        <!-- TDS Fetch Status Log (NEW DIAGNOSTIC SECTION) -->
        <div id="fetchStatusBlock" class="text-xs bg-gray-100 p-3 rounded-md mb-8 border border-gray-200">
            <p class="font-semibold text-gray-700 mb-1">TDS Fetch Status:</p>
            <p id="fetchStatus" class="text-gray-600 break-words">Initializing...</p>
        </div>

        <!-- Servo Control -->
        <div class="bg-white border rounded-lg p-6 shadow-sm">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Servo Motor Control</h2>
            
            <label for="servoRange" class="block text-sm font-medium text-gray-600 mb-2">
                Angle: <span id="currentAngle" class="text-blue-600 font-bold">90</span>째 (0째 to 180째)
            </label>
            
            <input type="range" id="servoRange" min="0" max="180" value="90" oninput="document.getElementById('currentAngle').innerText = this.value" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg mb-4">
            
            <button onclick="sendServoCommand()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg transform hover:scale-[1.01]">
                Set Servo Position
            </button>
            <p id="servoStatus" class="mt-3 text-sm text-center text-gray-500 h-4"></p>
        </div>

    </div>

    <script>
        // --- IMPORTANT: Replace with the IP address printed by your ESP8266 ---
        const ESP_IP = '192.168.4.1';
        const BASE_URL = `http://${ESP_IP}`;
        
        // Polling interval in milliseconds (e.g., fetch data every 2 seconds)
        const POLLING_INTERVAL = 2000; 

        /**
         * Task 1: Fetch Real-Time TDS Data
         */
        async function fetchTdsData() {
            const statusElement = document.getElementById('fetchStatus');
            statusElement.textContent = `Attempting GET to ${BASE_URL}/tds...`;
            
            try {
                // HTTP GET request to the /tds endpoint
                const response = await fetch(`${BASE_URL}/tds`);
                
                // Read the raw response text before attempting JSON parsing
                const responseText = await response.text(); 

                if (!response.ok) {
                    statusElement.textContent = `Error: HTTP Status ${response.status}. Raw response: ${responseText.substring(0, 100)}...`;
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Try parsing the text response as JSON
                let data = {};
                try {
                    data = JSON.parse(responseText);
                    statusElement.textContent = `SUCCESS. HTTP 200. Raw JSON received: ${responseText}`;
                } catch (e) {
                    statusElement.textContent = `Parsing Error! Received non-JSON text: ${responseText.substring(0, 100)}...`;
                    document.getElementById('tdsValue').textContent = 'PARSE ERR';
                    return; // Stop execution if parsing fails
                }

                const tdsValueElement = document.getElementById('tdsValue');
                
                // Update the UI with the real-time data
                if (data && data.tds_ppm !== undefined) {
                    // Check if tds_ppm exists and is not null/undefined
                    tdsValueElement.textContent = parseFloat(data.tds_ppm).toFixed(0);
                } else {
                    tdsValueElement.textContent = 'DATA ERR'; // Indicates successful fetch but unexpected JSON structure
                    statusElement.textContent += " (JSON structure missing 'tds_ppm' key)";
                }
                
                console.log("TDS Data Received:", data);

            } catch (error) {
                // Network or connection error
                console.error("Error fetching TDS data:", error);
                document.getElementById('tdsValue').textContent = 'NET ERR';
                document.getElementById('fetchStatus').textContent = `CRITICAL NETWORK FAILURE: ${error.message}`;
            }
        }

        /**
         * Task 2: Send Servo Control Command
         */
        async function sendServoCommand() {
            const angle = document.getElementById('servoRange').value;
            const statusElement = document.getElementById('servoStatus');
            statusElement.textContent = 'Sending command...';
            statusElement.classList.remove('text-red-500', 'text-green-500', 'text-gray-500');
            statusElement.classList.add('text-gray-500');
            
            try {
                // HTTP GET request to the /servo endpoint with an 'angle' query parameter
                const response = await fetch(`${BASE_URL}/servo?angle=${angle}`);
                
                const responseText = await response.text();
                
                if (response.ok) {
                    statusElement.textContent = `SUCCESS: Servo set to ${angle}째`;
                    statusElement.classList.remove('text-gray-500');
                    statusElement.classList.add('text-green-500');
                } else {
                    statusElement.textContent = `FAILED: ${responseText}`;
                    statusElement.classList.remove('text-gray-500');
                    statusElement.classList.add('text-red-500');
                    console.error("Servo Error:", responseText);
                }

            } catch (error) {
                statusElement.textContent = 'CONNECTION ERROR. Check IP/Wi-Fi.';
                statusElement.classList.remove('text-gray-500');
                statusElement.classList.add('text-red-500');
                console.error("Error sending servo command:", error);
            }
        }

        // Initialize and start polling
        window.onload = function() {
            // Fetch once immediately
            fetchTdsData(); 
            // Start polling for real-time updates
            setInterval(fetchTdsData, POLLING_INTERVAL);
        };

    </script>
</body>
</html>